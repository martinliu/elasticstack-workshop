---
title: "在CentOS上安装 Elastic Stack 7.16"
date: 2017-10-17T15:26:15Z
draft: false
weight: 21
---

本文讲解如何在 CentOS 8 上安装 Elastic Stack 7.16.3，包括：

* 虚拟机1
  * Elasticsearch
  * Kibana

* 虚拟机2
  * Logstash
  * MetricBeat

## 安装 Elasticsearch

### 系统准备

SSH 登陆虚拟机1，执行下面的命令。

```sh
hostnamectl set-hostname elk-1
systemctl status firewalld
systemctl stop firewalld
ping 192.168.1.132
```

SSH 登陆虚拟机2，执行下面的命令，安装 Logstash 所需要的 JDK。

```sh
hostnamectl set-hostname beat-1
systemctl status firewalld
systemctl stop firewalld
ping 192.168.1.141
yum install -y java-1.8.0-openjdk
java --version
```

### 选择最优 YUM repo

Elastic 官方网站

```sh
[elasticsearch]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=0
autorefresh=1
type=rpm-md
```

本文使用清华的镜像站点： https://mirror.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/7.16.3/

国内各大云厂商的开源镜像网站上都可以找到 Elastic Stack 的 yum 安装源。

### 安装 Elasticsearch

执行安装命令：

```sh
yum install -y https://mirror.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/7.16.3/elasticsearch-7.16.3-x86_64.rpm
```

查看默认的 Elasticsearch 配置文件，在最后增加一下四行：

```
cluster.name: elk101
network.host: 0.0.0.0
discovery.type: single-node
xpack.security.enabled: true
```

```sh
vi /etc/elasticsearch/elasticsearch.yml
```

启动服务：

```sh
systemctl daemon-reload
systemctl enable elasticsearch
systemctl start elasticsearch
systemctl status elasticsearch
```


检查服务的状态和日志：

```sh
ls /var/log/elasticsearch/
tail -f /var/log/elasticsearch/elk101.log
journalctl --unit elasticsearch

```

给 Elasticsearch 系统的所有内置账户设置统一密码 `elastic101` 「仅限测试目的」

```sh
[root@elk-1 ~]# /usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive -b
Enter password for [elastic]:
Reenter password for [elastic]:
Enter password for [apm_system]:
Reenter password for [apm_system]:
Enter password for [kibana_system]:
Reenter password for [kibana_system]:
Enter password for [logstash_system]:
Reenter password for [logstash_system]:
Enter password for [beats_system]:
Reenter password for [beats_system]:
Enter password for [remote_monitoring_user]:
Reenter password for [remote_monitoring_user]:
Changed password for user [apm_system]
Changed password for user [kibana_system]
Changed password for user [kibana]
Changed password for user [logstash_system]
Changed password for user [beats_system]
Changed password for user [remote_monitoring_user]
Changed password for user [elastic]
[root@elk-1 ~]
```

在浏览器里访问网址： `http://192.168.1.141:9200`；使用用户名密码【elastic / elastic101】登陆，应该能够看到下面的结果：

```sh
{
  "name" : "elk-1",
  "cluster_name" : "elk101",
  "cluster_uuid" : "dI50FfQtTlq13wlLI93fCw",
  "version" : {
    "number" : "7.16.3",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "4e6e4eab2297e949ec994e688dad46290d018022",
    "build_date" : "2022-01-06T23:43:02.825887787Z",
    "build_snapshot" : false,
    "lucene_version" : "8.10.1",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

## 安装 Kibana

在虚拟机1上，使用 Elasticserach 的选择的yum安装源服务器，执行如下安装命令：

```sh
yum install -y https://mirror.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/7.16.3/kibana-7.16.3-x86_64.rpm
```

从上到下的查看 kibana 配置文件，并在最后增加下面的内容：

```
server.host: "0.0.0.0"
elasticsearch.hosts: ["http://localhost:9200"]
elasticsearch.username: elastic
elasticsearch.password: elastic101
i18n.locale: zh-CN
server.publicBaseUrl: http://192.168.1.141:5601
```

启动 Kibana 服务：

```sh
systemctl daemon-reload
systemctl enable kibana
systemctl start kibana
```
使用下面的命令检查 Kibana 的状态和日志：

```sh
systemctl status kibana
tail -f /var/log/messages
```

在浏览器里访问网址： `http://192.168.1.141:5601`；使用用户名密码【elastic / elastic101】登陆，应该能够看到 Kibana 登陆后的中文界面。点击 “自己浏览” 按钮进入界面。

点击 “试用样例数据” 链接，添加并且查看三组样例数据。

## 安装 Logstash

SSh 登陆虚拟机2。先安装 Logstash。

```sh
yum install -y https://mirror.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/7.16.3/logstash-7.16.3-x86_64.rpm
```

用 vi 命令在 /tmp 下创建内容如下名为 mtgoxusd.csv 的数据文件。

```
Date,Open,High,Low,Close,Volume (BTC),Volume (Currency),Weighted Price
2014-02-25,173.2,173.84343,101.62872,135.0,29886.7532397,3667985.39624,122.729470372
2014-02-24,314.99996,316.78999,131.72093,173.871,94594.0225893,17590531.0124,185.958166604
2014-02-23,260.70495,348.98,220.1,309.99971,38395.103758,11051773.3535,287.843299581
2014-02-22,111.0,290.52557,96.6345,255.53,71861.2880229,11632970.1851,161.88090285
2014-02-21,111.61995,160.0,91.5,111.4,82102.9295521,9798282.70207,119.341450488
```

用 vi 命令创建 `vi /etc/logstash/conf.d/csv-loading.conf`
 内容如下的 logstash 流水线配置文件：


```sh
input {
  file {
    path => "/tmp/bitcon/*.csv"
    start_position => "beginning"
  }
}
filter {
  csv {
      separator => ","
#Date,Open,High,Low,Close,Volume (BTC),Volume (Currency),Weighted Price
     columns => ["Date","Open","High","Low","Close","Volume (BTC)", "Volume (Currency)" ,"Weighted Price"]
  }
}
output {
  elasticsearch {
     hosts => "http://192.168.1.141:9200"
     user  => elastic
     password => elastic101
     index => "bitcoin-prices"
  }
}
```
启动 Logstash 服务。


```sh
systemctl enable logstash
systemctl start logstash
```

使用命令  `tail -f /var/log/logstash/logstash-plain.log` 查看 Logstash 服务的输出文件。

在Kibana中执行一下流程，查看导入的数据：

* 在 ‘索引管理’ 中确认名为‘bitcoin-prices’的索引是否存在。
* 在 ‘索引模式‘ 中创建名为 ’bit*‘ 的索引模式。
* 在 ‘Discovery’ 中切换到 ‘bit*’ 索引模式，浏览导入的数据。

## 安装 Metricbeat

ssh 登陆到虚拟机2，安装 Metricbeat 采集这个服务器上的性能指标。

```sh
yum install -y https://mirror.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/7.16.3/metricbeat-7.16.3-x86_64.rpm
```

进入 Metricbeat 的配置文件目录cd /etc/metricbeat/，查看 Metricbeat 的配置目录，熟悉目录中的结构和文件。

初始化 Metricbeat 索引，在命令行下运行下面的命令，在执行前根据下面的参数解释，替换其中的相关参数。

```sh
metricbeat setup -e  --index-management   --dashboards \
  -E output.elasticsearch.hosts=['192.168.1.141:9200']   \
  -E output.elasticsearch.username=elastic   \
  -E output.elasticsearch.password=elastic101   \
  -E setup.kibana.host=192.168.1.141:5601
```

查看 Metricbeat 的采集模块，并启用 logstash 模块。

```sh
metricbeat modules list
```

从上到下的查看 /etc/metricbeat/metricbeat.yml 配置文件内容。

在当前目录下创建名为 mb.yml 的文件，内容如下：

```
metricbeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 10s

output.elasticsearch:
  hosts: ["192.168.1.141:9200"]
  username: "elastic"
  password: "elastic101"

setup.ilm.check_exists: false
logging.level: error
queue.spool: ~
monitoring.enabled: true
```

备份默认配置文件，并用以上配置文件替换默认文件。

```sh
mv /etc/metricbeat/metricbeat.yml /etc/metricbeat/metricbeat.yml.bk
cp mb.yml /etc/metricbeat/metricbeat.yml
```

测试配置文件的正确性

```sh
metricbeat test config
metricbeat test output
```

启动并查看 metricbeat 服务的状态。

```sh
systemctl enable  metricbeat
systemctl start  metricbeat
systemctl status  metricbeat
```

查看 Metricbeat 的相关仪表板：

* 打开 Kibana 界面
* 打开左侧菜单栏，点击 ‘Dashboard' 选项
* 在页面的搜索框中输入 system 后，查看 Metricbeat 自带的仪表板，它们是 setup 命令导入的。
* 点击查看名为 "[Metricbeat System] Overview ECS" 的仪表板。
在 System Overview 和 Host Overview 的两个视图中切换查看

## 管理 Elastic Stack

登陆 Kibana ，在 Management 菜单中点击 “堆栈监测”， 并点击 ok 按钮确认，查看集群的监控信息。

在 Stack Management 菜单中查看如下选项：

* 索引管理
* 用户
* 角色
* 索引模式
